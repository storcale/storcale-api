<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
</head>

<body>
    <button id="sidebarToggle" class="w3-button w3-xlarge w3-hide-large w3-teal" style="position:fixed;top:10px;left:10px;z-index:1001;">&#9776;</button>
    <div class="w3-sidebar w3-bar-block w3-card" style="width:150px;display:block;position:fixed;top:0;left:0;height:100vh;z-index:10;" id="mySidebar">
        <a href="#" class="w3-bar-item w3-button" id="log">Logs</a>
        <a href="#" class="w3-bar-item w3-button" id="key">Key Manager</a>
        <a href="#" class="w3-bar-item w3-button" id="docs">Docs</a>
    </div>

    <div id="main-wrapper" style="margin-left:150px; transition: margin-left 0.3s;">
        <div class="w3-main" id="main"></div>
        <div class="w3-teal">
            <div class="w3-container">
                <h1>Admin Dashboard</h1>
            </div>
            <div class="w3-container w3-grey " id="Description">
                <p>Welcome to the admin dashboard. Here you can manage your application settings.</p>
            </div>
            <div class="w3-panel w3-black w3-round-large" id="logs" style="display:none;">
            </div>
            <div id="notification" class="w3-panel w3-green w3-display-container" style="display:none;position:fixed;top:10px;right:10px;z-index:1000;"></div>
            <div id="keys" class="w3-container w3-grey" style="display:none;">
                <div class="w3-card-2 w3-margin">
                    <header class="w3-container w3-teal">
                        <h1>API Key</h1>
                    </header>
                        <input type="text" id="tnivKeyInput" placeholder="Enter TNIV API Key" class="w3-margin" />
                </div>
                <div class="w3-card-4 w3-margin">
                    <header class="w3-container w3-orange">
                        <h1>Add/Remove keys</h1>
                    </header>

                    <div class="w3-container">
                        <input type="text" id="categoryInput" placeholder="Enter category " class="w3-margin-top" />
                        <input type="text" id="keyInput" placeholder="Enter Key" />
                        <div class="w3-padding-16 w3-margin-bottom">
                            <button class="w3-button w3-green w3-large">Add</button>
                            <button class="w3-button w3-red w3-large">Remove</button>

                        </div>
                    </div>
                </div>
                <div class="w3-card-4 w3-margin">
                    <header class="w3-container w3-yellow">
                        <h1>Update keys</h1>
                    </header>

                    <div class="w3-container">
                        <div class="w3-padding-4 w3-margin-top">
                            <input type="text" id="categoryInputUpdate" placeholder="Enter category" />
                            <input type="text" id="keyInputUpdateAdd" placeholder="Enter NEW Key" />
                        </div>
                        <div class="w3-padding-16 w3-margin-bottom">
                            <button class="w3-button w3-blue w3-large">Update</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        #main-wrapper {
            margin-left: 150px;
            transition: margin-left 0.3s;
        }
        #mySidebar {
            transition: left 0.3s, display 0.3s;
        }
        @media (max-width: 800px) {
            #main-wrapper {
                margin-left: 0 !important;
            }
            #mySidebar {
                display: none !important;
                left: 0;
                box-shadow: none;
            }
            #mySidebar.open {
                display: block !important;
                left: 0;
                box-shadow: 2px 0 8px rgba(0,0,0,0.2);
            }
            #sidebarToggle {
                display: block !important;
            }
        }
        @media (min-width: 801px) {
            #sidebarToggle {
                display: none !important;
            }
            #mySidebar {
                display: block !important;
                left: 0 !important;
            }
            #main-wrapper {
                margin-left: 150px !important;
            }
        }
    </style>
    <script>
        // Sidebar toggle s
        const sidebar = document.getElementById('mySidebar');
        const mainWrapper = document.getElementById('main-wrapper');
        const sidebarToggle = document.getElementById('sidebarToggle');
        function closeSidebarMobile() {
            sidebar.classList.remove('open');
        }
        function openSidebarMobile() {
            sidebar.classList.add('open');
        }
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                if (sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                } else {
                    sidebar.classList.add('open');
                }
            });
        }
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 800 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(e.target) && e.target !== sidebarToggle) {
                    sidebar.classList.remove('open');
                }
            }
        });
        window.addEventListener('resize', function() {
            if (window.innerWidth > 800) {
                sidebar.classList.remove('open');
            }
        });
        document.getElementById('log').addEventListener('click', async function () {
            const logsContainer = document.getElementById('logs');
            logsContainer.style.display = 'block';
            document.getElementById('Description').innerHTML = "<p>Logs.</p>"
            document.getElementById('keys').style.display = 'none';
            logsContainer.innerHTML = '<p>Fetching logs...</p>';


            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api-key');

            try {
                const response = await fetch('/api/admin/logs', {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "api-key": apiKey
                    }
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                logsContainer.innerHTML = '<p>Logs fetched successfully.</p>';
                const logList = document.getElementById('logList') || document.createElement('ul');
                logList.className = 'w3-ul w3-card-4 w3-hoverable';
                if (data && Array.isArray(data.logs)) {
                    data.logs.forEach(log => {

                        const listItem = document.createElement('li');
                        listItem.textContent = log;
                        if (log.includes("admin")) { listItem.className = ' w3-pale-red w3-text-green'; } else { listItem.className = 'w3-text-green'; }
                        logList.appendChild(listItem);
                    });
                } else {
                    logsContainer.innerHTML += '<p>No logs found or invalid response.</p>';
                }
                logsContainer.appendChild(logList);
            } catch (error) {
                logsContainer.innerHTML = `<p>Error fetching logs: ${error.message}</p>`;
            }

        });
        document.getElementById('docs').addEventListener('click', function () {
            window.location.href = `/api-docs`;
        });
        document.getElementById('key').addEventListener('click', function () {
            const keysContainer = document.getElementById('keys');
            keysContainer.style.display = 'block';
            document.getElementById('Description').innerHTML = "<p>Add, remove and update categories keys here.</p>"
            document.getElementById('logs').style.display = 'none';
        });

        // Notification helper
        function showNotification(msg, color = 'w3-green') {
            const note = document.getElementById('notification');
            note.className = `w3-panel ${color} w3-display-container`;
            note.innerHTML = `<span onclick=\"this.parentElement.style.display='none'\" class='w3-button w3-large w3-display-topright'>&times;</span>${msg}`;
            note.style.display = 'block';
            setTimeout(() => { note.style.display = 'none'; }, 6000);
        }

        // Add Key
        document.querySelector('#keys .w3-button.w3-green.w3-large').addEventListener('click', async function (e) {
            if (e.target.textContent.trim() !== 'Add') return;
            const category = document.getElementById('categoryInput').value.trim();
            const key = document.getElementById('keyInput').value.trim();
            const tnivKey = document.getElementById('tnivKeyInput').value.trim();
            const result = await fetch('/api/tniv/internal/addKey', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': tnivKey
                },
                body: JSON.stringify({ focus: category, spreadsheetId: key })
            });
            const data = await result.json();
            showNotification(data.body || data.error || 'Unknown result', data.error ? 'w3-red' : 'w3-green');
        });

        // Remove Key
        document.querySelector('#keys .w3-button.w3-red.w3-large').addEventListener('click', async function (e) {
            if (e.target.textContent.trim() !== 'Remove') return;
            const category = document.getElementById('categoryInput').value.trim();
            const key = document.getElementById('keyInput').value.trim();
            const tnivKey = document.getElementById('tnivKeyInput').value.trim();
            const result = await fetch('/api/tniv/internal/removeKey', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': tnivKey
                },
                body: JSON.stringify({ focus: category, spreadsheetId: key })
            });
            const data = await result.json();
            showNotification(data.body || data.error || 'Unknown result', data.error ? 'w3-red' : 'w3-green');
        });

        // Update Key
        document.querySelector('#keys .w3-button.w3-blue.w3-large').addEventListener('click', async function (e) {
            if (e.target.textContent.trim() !== 'Update') return;
            const category = document.getElementById('categoryInputUpdate').value.trim();
            const newKey = document.getElementById('keyInputUpdateAdd').value.trim();
            const tnivKey = document.getElementById('tnivKeyInput').value.trim();
            let msg = '';
            const addRes = await fetch('/api/tniv/internal/updateKey', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': tnivKey
                },
                body: JSON.stringify({ focus: category, spreadsheetId: newKey })
            });
            const addData = await addRes.json();
            msg += (addData.body || addData.error || 'New key added.');
            showNotification(msg, addData.error ? 'w3-red' : 'w3-green');
        });
    </script>
</body>

</html>